<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>FlightSim 3D</title>
    <!-- Tailwind CSS v3 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0284c7',
                        secondary: '#0ea5e9',
                        accent: '#38bdf8',
                        dark: '#0c4a6e',
                        light: '#e0f2fe'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    animation: {
                        'float': 'float 3s ease-in-out infinite',
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        }
                    }
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .text-shadow {
                text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            }
            .text-shadow-lg {
                text-shadow: 0 4px 8px rgba(0, 0, 0, 0.7);
            }
            .backdrop-blur-xl {
                backdrop-filter: blur(24px);
            }
            .glass-effect {
                background: rgba(255, 255, 255, 0.1);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.2);
            }
            .glass-effect-dark {
                background: rgba(12, 74, 110, 0.7);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.1);
            }
            .btn-3d {
                transform-style: preserve-3d;
                transform: perspective(1000px);
            }
            .btn-3d-effect {
                transition: all 0.2s ease;
            }
            .btn-3d-effect:hover {
                transform: translateY(-3px) translateZ(5px);
                box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            }
            .btn-3d-effect:active {
                transform: translateY(0) translateZ(0);
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            }
        }
    </style>
    
    <style>
        body { 
            margin: 0; 
            overflow: hidden;
            font-family: 'Inter', system-ui, sans-serif;
        }
        canvas { 
            display: block; 
            position: absolute;
            top: 0;
            left: 0;
            z-index: 0;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(12, 74, 110, 0.1);
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(2, 132, 199, 0.8);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(2, 132, 199, 1);
        }
        
        /* Control hints animation */
        .control-hint {
            opacity: 0;
            transform: translateY(10px);
            animation: fadeInUp 0.5s ease forwards;
        }
        
        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Animated gradient background */
        .animated-bg {
            background: linear-gradient(-45deg, #0c4a6e, #0369a1, #0ea5e9, #38bdf8);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
        }
        
        @keyframes gradientBG {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }
        
        /* Pulse effect for buttons */
        .pulse-button {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(56, 189, 248, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(56, 189, 248, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(56, 189, 248, 0);
            }
        }
    </style>
</head>
<body>
    <!-- Game Menu -->
    <div id="menu" class="fixed inset-0 z-10 flex items-center justify-center animated-bg">
        <div class="glass-effect rounded-3xl p-8 md:p-12 w-full max-w-4xl mx-4 transform transition-all duration-500">
            <div class="flex flex-col items-center">
                <!-- Logo -->
                <div class="mb-8 animate-float">
                    <img src="https://p9-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/5da0d23384af4bb190e7060414fa396a~tplv-a9rns2rl98-image.image?lk3s=8e244e95&rcl=202602272001049BE8BF3BA5AC04B12742&rrcfp=f06b921b&x-expires=1774785682&x-signature=JTGl9R4fyBI0M3Nu%2FDFMyhjprv4%3D" 
                         alt="FlightSim Logo" 
                         class="w-32 h-32 md:w-40 md:h-40 object-contain">
                </div>
                
                <!-- Title -->
                <h1 class="text-5xl md:text-6xl font-bold text-white mb-6 text-shadow-lg">FlightSim 3D</h1>
                <p class="text-xl text-light mb-10 text-center max-w-2xl">Experience the thrill of flying with realistic 3D aircraft simulation</p>
                
                <!-- Vehicle Selection -->
                <div class="w-full max-w-md mb-8">
                    <label for="vehicleSelect" class="block text-white text-lg mb-2 font-medium">Choose your vehicle:</label>
                    <div class="relative">
                        <select id="vehicleSelect" 
                                class="w-full bg-dark/50 border border-accent/30 rounded-lg px-4 py-3 text-white appearance-none focus:outline-none focus:ring-2 focus:ring-accent">
                            <option value="airplane1">‚úàÔ∏è Airplane 1 (White)</option>
                            <option value="airplane2">‚úàÔ∏è Airplane 2 (Red)</option>
                            <option value="car">üöì Airport Security Car</option>
                        </select>
                        <div class="absolute right-4 top-1/2 transform -translate-y-1/2 pointer-events-none text-accent">
                            <i class="fa fa-chevron-down"></i>
                        </div>
                    </div>
                </div>
                
                <!-- Start Position Buttons -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 w-full max-w-2xl mb-8">
                    <button onclick="startGame('runway')" 
                            class="btn-3d btn-3d-effect bg-primary hover:bg-primary/90 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-300 flex flex-col items-center">
                        <i class="fa fa-plane text-2xl mb-2"></i>
                        Start on Runway
                    </button>
                    <button onclick="startGame('midair')" 
                            class="btn-3d btn-3d-effect bg-secondary hover:bg-secondary/90 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-300 flex flex-col items-center">
                        <i class="fa fa-cloud text-2xl mb-2"></i>
                        Start in Mid-Air
                    </button>
                    <button onclick="startGame('ground')" 
                            class="btn-3d btn-3d-effect bg-dark hover:bg-dark/90 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-300 flex flex-col items-center">
                        <i class="fa fa-car text-2xl mb-2"></i>
                        Start on Ground
                    </button>
                </div>
                
                <!-- Options -->
                <div class="flex items-center mb-8">
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="crashAnimationCheckbox" 
                               class="sr-only peer">
                        <div class="relative w-11 h-6 bg-gray-700 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-accent rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-accent"></div>
                        <span class="ml-3 text-white">Enable Crash Animation</span>
                    </label>
                </div>
                                <!-- Multiplayer Toggle -->
                <div class="w-full max-w-md mb-4 mt-4">
                    <div class="flex items-center justify-between">
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="multiplayerToggle" 
                                   class="sr-only peer">
                            <div class="relative w-11 h-6 bg-gray-700 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-accent rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div>
                            <span class="ml-3 text-white font-medium">Enable AI Battle</span>
                        </label>
                        <span class="text-accent text-sm" id="playerCountDisplay">0 AI online</span>
                    </div>
                    
                    <!-- Nickname Input (hidden by default) -->
                    <div id="nicknameContainer" class="mt-3 hidden transition-all duration-300">
                        <label for="nicknameInput" class="block text-white text-sm mb-1">Enter your nickname:</label>
                        <div class="flex">
                            <input type="text" id="nicknameInput" 
                                   class="flex-1 bg-dark/50 border border-accent/30 rounded-l-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-accent"
                                   placeholder="Pilot" maxlength="20" value="Player">
                            <button id="setNicknameBtn" 
                                    class="bg-accent hover:bg-accent/90 text-dark font-semibold px-4 py-2 rounded-r-lg transition-all duration-300">
                                Set
                            </button>
                        </div>
                        <p class="text-light text-xs mt-1">SPACE: Missile (1.5s) | J: Flare (2.5s)</p>
                    </div>
                </div>
                <!-- Controls Info Button -->
                <button onclick="showControlsModal()" 
                        class="text-light hover:text-white transition-colors duration-300 flex items-center">
                    <i class="fa fa-question-circle mr-2"></i>
                    View Controls
                </button>
            </div>
        </div>
    </div>
    
    <!-- Controls Modal -->
    <div id="controlsModal" class="fixed inset-0 z-50 flex items-center justify-center bg-dark/80 backdrop-blur-sm opacity-0 pointer-events-none transition-opacity duration-300">
        <div class="glass-effect rounded-3xl p-6 max-w-2xl w-full mx-4 transform scale-95 transition-transform duration-300 max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-semibold text-white">Game Controls</h3>
                <button onclick="hideControlsModal()" class="text-white hover:text-accent transition-colors">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="overflow-y-auto flex-grow pr-2" style="max-height: calc(80vh - 100px);">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="glass-effect-dark rounded-lg p-4 control-hint" style="animation-delay: 0.1s">
                        <div class="flex items-center mb-2">
                            <span class="bg-dark text-white rounded px-2 py-1 mr-3 font-mono">S</span>
                            <span class="text-light">Ascend (Nose Up) ‚Äî S ‰∏äÂçá</span>
                        </div>
                    </div>
                    <div class="glass-effect-dark rounded-lg p-4 control-hint" style="animation-delay: 0.2s">
                        <div class="flex items-center mb-2">
                            <span class="bg-dark text-white rounded px-2 py-1 mr-3 font-mono">W</span>
                            <span class="text-light">Descend (Nose Down) ‚Äî W ‰∏ãÈôç</span>
                        </div>
                    </div>
                    <div class="glass-effect-dark rounded-lg p-4 control-hint" style="animation-delay: 0.3s">
                        <div class="flex items-center mb-2">
                            <span class="bg-dark text-white rounded px-2 py-1 mr-3 font-mono">A</span>
                            <span class="text-light">Turn / Yaw Left (and visual roll left)</span>
                        </div>
                    </div>
                    <div class="glass-effect-dark rounded-lg p-4 control-hint" style="animation-delay: 0.4s">
                        <div class="flex items-center mb-2">
                            <span class="bg-dark text-white rounded px-2 py-1 mr-3 font-mono">D</span>
                            <span class="text-light">Turn / Yaw Right (and visual roll right)</span>
                        </div>
                    </div>
                    <div class="glass-effect-dark rounded-lg p-4 control-hint" style="animation-delay: 0.5s">
                        <div class="flex items-center mb-2">
                            <span class="bg-dark text-white rounded px-2 py-1 mr-3 font-mono">‚Üë / ‚Üì</span>
                            <span class="text-light">Throttle (Increase/Decrease Speed)</span>
                        </div>
                    </div>
                    <div class="glass-effect-dark rounded-lg p-4 control-hint" style="animation-delay: 0.6s">
                        <div class="flex items-center mb-2">
                            <span class="bg-dark text-white rounded px-2 py-1 mr-3 font-mono">1-4</span>
                            <span class="text-light">Camera Views</span>
                        </div>
                    </div>
                    
                    <!-- Additional controls can be added here -->
                    <div class="glass-effect-dark rounded-lg p-4 control-hint" style="animation-delay: 0.7s">
                        <div class="flex items-center mb-2">
                            <span class="bg-dark text-white rounded px-2 py-1 mr-3 font-mono">R</span>
                            <span class="text-light">Restart Game</span>
                        </div>
                    </div>
                    <div class="glass-effect-dark rounded-lg p-4 control-hint" style="animation-delay: 0.8s">
                        <div class="flex items-center mb-2">
                            <span class="bg-dark text-white rounded px-2 py-1 mr-3 font-mono">ESC</span>
                            <span class="text-light">Pause Menu</span>
                        </div>
                    </div>
                                        <!-- Âú®ÊéßÂà∂Èù¢ÊùøÁöÑ Additional controls ÈÉ®ÂàÜ‰πãÂêéÊ∑ªÂä† -->
                    <div class="glass-effect-dark rounded-lg p-4 control-hint" style="animation-delay: 0.9s">
                        <div class="flex items-center mb-2">
                            <span class="bg-dark text-white rounded px-2 py-1 mr-3 font-mono">SPACE</span>
                            <span class="text-light">Fire Missile (1.5s cooldown) ‚Äî ÂèëÂ∞ÑËøΩË∏™ÂØºÂºπ</span>
                        </div>
                    </div>
                    <div class="glass-effect-dark rounded-lg p-4 control-hint" style="animation-delay: 1.0s">
                        <div class="flex items-center mb-2">
                            <span class="bg-dark text-white rounded px-2 py-1 mr-3 font-mono">J</span>
                            <span class="text-light">Fire Flare (2.5s cooldown) ‚Äî ÂèëÂ∞ÑÈò≤Âæ°ÁÇÆ</span>
                        </div>
                    </div>
                    <!-- Vehicle-specific controls -->
                    <div class="glass-effect-dark rounded-lg p-4 control-hint col-span-1 md:col-span-2" style="animation-delay: 0.9s">
                        <h4 class="text-white font-semibold mb-2">Airplane Controls</h4>
                        <p class="text-light text-sm">S ‰∏äÂçá (nose up), W ‰∏ãÈôç (nose down). A/D yaw left/right. Arrow keys control throttle.</p>
                    </div>
                    
                    <div class="glass-effect-dark rounded-lg p-4 control-hint col-span-1 md:col-span-2" style="animation-delay: 1.0s">
                        <h4 class="text-white font-semibold mb-2">Car Controls</h4>
                        <p class="text-light text-sm">Use A/D to steer left/right. Use arrow keys to control speed. The car will automatically stay on the ground.</p>
                    </div>
                </div>
            </div>
            
            <div class="mt-6 text-center">
                <button onclick="hideControlsModal()" 
                        class="bg-primary hover:bg-primary/90 text-white font-semibold py-2 px-6 rounded-xl transition-all duration-300">
                    Close
                </button>
            </div>
        </div>
    </div>
    
        <!-- HUD (Heads-Up Display) -->
    <div id="hud" class="fixed top-0 left-0 w-full h-full pointer-events-none z-10 p-4 md:p-6 opacity-0 transition-opacity duration-500">
        <!-- Top Left: Flight Data -->
        <div class="absolute top-4 left-4 glass-effect-dark rounded-xl p-4 max-w-xs">
            <div class="flex justify-between items-center mb-3">
                <h3 class="text-white font-semibold text-lg">Flight Data</h3>
                <div class="text-accent text-sm" id="currentVehicle">Airplane</div>
            </div>
            <div class="space-y-2">
                <div class="flex justify-between">
                    <span class="text-light">Speed:</span>
                    <span class="text-white font-mono" id="speed">0.00</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-light">Altitude:</span>
                    <span class="text-white font-mono" id="altitude">0.00</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-light">Heading:</span>
                    <span class="text-white font-mono" id="heading">0.00¬∞</span>
                </div>
            </div>
        </div>
        
        <!-- Top Center: Main HUD Container -->
        <div class="absolute top-4 left-1/2 transform -translate-x-1/2 flex flex-col items-center space-y-2" style="z-index: 20; width: auto; min-width: 300px;">
            <!-- Multiplayer Info -->
            <div id="multiplayerHud" class="glass-effect-dark rounded-xl px-6 py-2 hidden w-full text-center">
                <div class="flex items-center justify-center space-x-4">
                    <div class="text-accent">
                        <i class="fa fa-users"></i>
                    </div>
                    <div class="text-white" id="onlinePlayersCount">0</div>
                    <div class="text-light">AI online</div>
                    <div class="text-green-400" id="playerNameDisplay"></div>
                </div>
            </div>
            
            <!-- Player Lives Display (Âè™Âú®AIÊ®°Âºè‰∏ãÊòæÁ§∫) -->
            <div id="livesDisplay" class="glass-effect-dark rounded-xl px-4 py-2 hidden w-full text-center">
                <span class="text-light">Lives:</span>
                <span class="text-white font-bold ml-2" id="playerLives">3</span>
                <span class="text-light ml-2">Score:</span>
                <span class="text-yellow-400 font-bold ml-2" id="playerScore">0</span>
            </div>
            
            <!-- Threat Warning Container (ÊâÄÊúâË≠¶ÂëäÂûÇÁõ¥ÊéíÂàó) -->
            <div id="warningContainer" class="flex flex-col items-center space-y-2 w-full">
                <!-- Missile Incoming Warning -->
                <div id="threatWarning" class="glass-effect-dark rounded-xl px-4 py-2 hidden w-full text-center border-2 border-red-500">
                    <div class="flex items-center justify-center space-x-2">
                        <i class="fa fa-exclamation-triangle text-red-500 animate-pulse"></i>
                        <span class="text-white font-semibold">üöÄ MISSILE INCOMING!</span>
                        <i class="fa fa-exclamation-triangle text-red-500 animate-pulse"></i>
                    </div>
                </div>
                
                <!-- Enemy Proximity Warning (Êñ∞Âä†) -->
                <div id="proximityWarning" class="glass-effect-dark rounded-xl px-4 py-2 hidden w-full text-center border-2 border-orange-500">
                    <div class="flex items-center justify-center space-x-2">
                        <i class="fa fa-bullseye text-orange-500 animate-ping"></i>
                        <span class="text-white font-semibold">‚ö†Ô∏è ENEMY CLOSE! ‚ö†Ô∏è</span>
                        <i class="fa fa-bullseye text-orange-500 animate-ping"></i>
                    </div>
                </div>
                
                <!-- Invincibility Indicator -->
                <div id="invincibilityIndicator" class="hidden w-full text-center">
                    <div class="glass-effect-dark rounded-full px-6 py-2 border-2 border-yellow-400 inline-block">
                        <span class="text-yellow-400 font-bold animate-pulse">üõ°Ô∏è INVINCIBLE üõ°Ô∏è</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Top Right: Compass -->
        <div class="absolute top-4 right-4 glass-effect-dark rounded-xl p-4 w-48 h-48 flex items-center justify-center" style="z-index: 10;">
            <div class="relative w-full h-full">
                <div class="absolute inset-0 flex items-center justify-center">
                    <div class="w-32 h-32 rounded-full border-2 border-accent/50 relative">
                        <!-- Compass markings -->
                        <div class="absolute top-0 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-white font-bold">N</div>
                        <div class="absolute top-1/2 right-0 transform translate-x-1/2 -translate-y-1/2 text-white font-bold">E</div>
                        <div class="absolute bottom-0 left-1/2 transform -translate-x-1/2 translate-y-1/2 text-white font-bold">S</div>
                        <div class="absolute top-1/2 left-0 transform -translate-x-1/2 -translate-y-1/2 text-white font-bold">W</div>
                        <div class="relative w-full h-full flex items-center justify-center">
                            <svg id="compassNeedle" viewBox="0 0 100 100" class="w-24 h-24"
                                 style="transform-origin:50% 50%; transform-box:view-box; display:block;">
                                <polygon points="50,12 62,50 50,44 38,50" fill="#ff4d4d" />
                            </svg>
                            <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-2 h-2 rounded-full bg-white pointer-events-none"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Bottom Center: Camera View Indicator -->
        <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 glass-effect-dark rounded-xl px-6 py-2">
            <div class="flex space-x-4">
                <button onclick="switchCamera(0)" class="camera-btn text-white hover:text-accent transition-colors" data-camera="0">
                    <i class="fa fa-eye"></i> External
                </button>
                <button onclick="switchCamera(1)" class="camera-btn text-white hover:text-accent transition-colors" data-camera="1">
                    <i class="fa fa-pilot"></i> Cockpit
                </button>
                <button onclick="switchCamera(2)" class="camera-btn text-white hover:text-accent transition-colors" data-camera="2">
                    <i class="fa fa-plane"></i> Wing
                </button>
                <button onclick="switchCamera(3)" class="camera-btn text-white hover:text-accent transition-colors" data-camera="3">
                    <i class="fa fa-cog"></i> Gear
                </button>
            </div>
        </div>
        
        <!-- Bottom Left: Speed Indicator -->
        <div class="absolute bottom-4 left-4 glass-effect-dark rounded-xl p-3 flex items-center">
            <div class="mr-3 text-accent">
                <i class="fa fa-tachometer text-2xl"></i>
            </div>
            <div>
                <div class="text-xs text-light">SPEED</div>
                <div class="text-xl text-white font-mono" id="speedLarge">0</div>
            </div>
        </div>
        
        <!-- Bottom Right: Altitude Indicator -->
        <div class="absolute bottom-4 right-4 glass-effect-dark rounded-xl p-3 flex items-center">
            <div class="mr-3 text-accent">
                <i class="fa fa-arrow-up text-2xl"></i>
            </div>
            <div>
                <div class="text-xs text-light">ALTITUDE</div>
                <div class="text-xl text-white font-mono" id="altitudeLarge">0</div>
            </div>
        </div>
    </div>
    
    <!-- ESC Pause Menu -->
    <div id="escMenu" class="fixed inset-0 z-20 flex items-center justify-center bg-dark/70 backdrop-blur-sm opacity-0 pointer-events-none transition-opacity duration-300">
        <div class="glass-effect rounded-3xl p-8 max-w-md w-full mx-4 transform scale-95 transition-transform duration-300">
            <div class="flex flex-col items-center">
                <h2 class="text-4xl font-bold text-white mb-6 text-shadow">Game Paused</h2>
                
                <div class="space-y-4 w-full mb-8">
                    <button onclick="togglePause()" 
                            class="w-full bg-primary hover:bg-primary/90 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-300 flex items-center justify-center">
                        <i class="fa fa-play mr-2"></i>
                        Resume Game
                    </button>
                    
                    <button onclick="restartGame()" 
                            class="w-full bg-secondary hover:bg-secondary/90 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-300 flex items-center justify-center">
                        <i class="fa fa-refresh mr-2"></i>
                        Restart Game
                    </button>
                    
                    <button onclick="returnToMenu()" 
                            class="w-full bg-dark hover:bg-dark/90 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-300 flex items-center justify-center">
                        <i class="fa fa-home mr-2"></i>
                        Return to Main Menu
                    </button>
                </div>
                
                <div class="text-center text-light text-sm">
                    <p>Created by Bilibili_È£ûÁöÑÊô∫Âä®</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Game Over Screen -->
    <div id="gameOverScreen" class="fixed inset-0 z-20 flex items-center justify-center bg-dark/80 backdrop-blur-sm opacity-0 pointer-events-none transition-opacity duration-500">
        <div class="glass-effect rounded-3xl p-8 max-w-md w-full mx-4 transform scale-95 transition-transform duration-300">
            <div class="flex flex-col items-center">
                <div class="w-24 h-24 rounded-full bg-red-600/20 flex items-center justify-center mb-6">
                    <i class="fa fa-exclamation-triangle text-4xl text-red-500"></i>
                </div>
                
                <h2 class="text-4xl font-bold text-white mb-2 text-shadow">Game Over</h2>
                <p class="text-xl text-light mb-8 text-center">You have crashed!</p>
                
                <div class="space-y-4 w-full mb-8">
                    <button onclick="restartGame()" 
                            class="w-full bg-primary hover:bg-primary/90 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-300 flex flex-col items-center justify-center pulse-button">
                        <i class="fa fa-refresh mr-2"></i>
                        Try Again
                    </button>
                    
                    <button onclick="returnToMenu()" 
                            class="w-full bg-dark hover:bg-dark/90 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-300 flex items-center justify-center">
                        <i class="fa fa-home mr-2"></i>
                        Return to Main Menu
                    </button>
                </div>
                
                <div class="text-center text-light text-sm">
                    <p>Final Score</p>
                    <p class="text-3xl font-bold text-white mt-2" id="finalScore">0</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Three.js Script -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // Scene setup
        var scene = new THREE.Scene();
        var camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        var cockpitCamera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        var wingCamera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        var gearCamera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        var currentCamera = camera;
        var currentCameraIndex = 0;

        // Renderer setup
        var renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setClearColor(0x87CEEB); // Set the background color to sky blue
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap; // Improved shadow quality
        renderer.outputEncoding = THREE.sRGBEncoding; // Ensure proper color rendering
        document.body.appendChild(renderer.domElement);

        // Add lights
        var ambientLight = new THREE.AmbientLight(0xffffff, 0.8); // Increased intensity for better lighting
        scene.add(ambientLight);
        
        var directionalLight = new THREE.DirectionalLight(0xffffff, 1.0); // Increased intensity
        directionalLight.position.set(50, 100, 50);
        directionalLight.castShadow = true;
        directionalLight.shadow.mapSize.width = 4096; // Higher resolution shadows
        directionalLight.shadow.mapSize.height = 4096;
        directionalLight.shadow.camera.near = 0.5;
        directionalLight.shadow.camera.far = 500;
        directionalLight.shadow.camera.left = -150;
        directionalLight.shadow.camera.right = 150;
        directionalLight.shadow.camera.top = 150;
        directionalLight.shadow.camera.bottom = -150;
        directionalLight.shadow.camera.updateProjectionMatrix();
        scene.add(directionalLight);
		// Ê∑ªÂä†Á¨¨‰∫å‰∏™ÊñπÂêëÂÖâ‰Ωú‰∏∫Ë°•ÂÖâÔºåÂáèÂ∞ëËÉåÂÖâÈù¢ËøáÊöó
var fillLight = new THREE.DirectionalLight(0xffffff, 0.4);
fillLight.position.set(-50, 30, -50);
fillLight.castShadow = false; // ‰∏ç‰∫ßÁîüÈò¥ÂΩ±ÔºåÂè™Êèê‰æõÁÖßÊòé
scene.add(fillLight);
        // Create an airplane
        function createAirplane(color) {
            var airplaneGeometry = new THREE.BoxGeometry(1, 0.5, 2); // Longer body
            var airplaneMaterial = new THREE.MeshPhongMaterial({ 
                color: color,
                shininess: 100,
                specular: 0x111111
            });
            var airplane = new THREE.Mesh(airplaneGeometry, airplaneMaterial);
            airplane.castShadow = true;
            airplane.receiveShadow = true;

            // Add cockpit (triangular shape)
            var cockpitGeometry = new THREE.ConeGeometry(0.3, 0.5, 4);
            var cockpitMaterial = new THREE.MeshPhongMaterial({ 
                color: 0x888888,
                shininess: 100,
                specular: 0x333333
            });
            var cockpit = new THREE.Mesh(cockpitGeometry, cockpitMaterial);
            cockpit.position.set(0, 0, 1.25);
            cockpit.rotation.x = Math.PI / 2;
            cockpit.castShadow = true;
            cockpit.receiveShadow = true;
            airplane.add(cockpit);

            // Add wings
            var wingGeometry = new THREE.BoxGeometry(2, 0.1, 0.5); // Wider wings
            var wingMaterial = new THREE.MeshPhongMaterial({ 
                color: 0x0000ff,
                shininess: 100,
                specular: 0x111111
            });

            var leftWing = new THREE.Mesh(wingGeometry, wingMaterial);
            leftWing.position.set(-1, 0, 0);
            leftWing.castShadow = true;
            leftWing.receiveShadow = true;
            airplane.add(leftWing);

            var rightWing = new THREE.Mesh(wingGeometry, wingMaterial);
            rightWing.position.set(1, 0, 0);
            rightWing.castShadow = true;
            rightWing.receiveShadow = true;
            airplane.add(rightWing);

            // Add empennages (tail fins)
            var tailGeometry = new THREE.BoxGeometry(0.1, 1, 0.3);
            var tailMaterial = new THREE.MeshPhongMaterial({ 
                color: 0x0000ff,
                shininess: 100,
                specular: 0x111111
            });

            var leftTail = new THREE.Mesh(tailGeometry, tailMaterial);
            leftTail.position.set(-0.3, 0.1, -0.8);
            leftTail.rotation.z = 92.7;
            leftTail.castShadow = true;
            leftTail.receiveShadow = true;
            airplane.add(leftTail);

            var rightTail = new THREE.Mesh(tailGeometry, tailMaterial);
            rightTail.position.set(0.3, 0.1, -0.8);
            rightTail.rotation.z = 92.7;
            rightTail.castShadow = true;
            rightTail.receiveShadow = true;
            airplane.add(rightTail);

            var verticalTailGeometry = new THREE.BoxGeometry(0.1, 0.5, 0.68);
            var verticalTail = new THREE.Mesh(verticalTailGeometry, tailMaterial);
            verticalTail.position.set(0, 0.3, -0.80);
            verticalTail.rotation.x = Math.PI / 2;
            verticalTail.castShadow = true;
            verticalTail.receiveShadow = true;
            airplane.add(verticalTail);

            // Add landing gear
            var gearGeometry = new THREE.BoxGeometry(0.2, 0.2, 0.2);
            var gearMaterial = new THREE.MeshPhongMaterial({ 
                color: 0x000000,
                shininess: 30,
                specular: 0x333333
            });

            var frontGear = new THREE.Mesh(gearGeometry, gearMaterial);
            frontGear.position.set(0, -0.3, 0.6);
            frontGear.castShadow = true;
            frontGear.receiveShadow = true;
            airplane.add(frontGear);

            var leftGear = new THREE.Mesh(gearGeometry, gearMaterial);
            leftGear.position.set(-0.3, -0.3, -0.25);
            leftGear.castShadow = true;
            leftGear.receiveShadow = true;
            airplane.add(leftGear);

            var rightGear = new THREE.Mesh(gearGeometry, gearMaterial);
            rightGear.position.set(0.3, -0.3, -0.25);
            rightGear.castShadow = true;
            rightGear.receiveShadow = true;
            airplane.add(rightGear);

            return airplane;
        }
		
		
        var airplane1 = createAirplane(0xffffff);
        var airplane2 = createAirplane(0xff0000);

        // Create a car - FIXED to prevent inversion at certain angles
        function createCar() {
            var carGroup = new THREE.Group();
            carGroup.rotation.order = 'YXZ'; // ÂÖ≥ÈîÆÔºöÊää rotation.order ËÆæ‰∏∫ 'YXZ'
            // ‰∏ªËΩ¶Ë∫´
            var carGeometry = new THREE.BoxGeometry(0.5, 0.5, 1);
            var carMaterial = new THREE.MeshPhongMaterial({ color: 0x000000, shininess: 100, specular: 0x333333 });
            var body = new THREE.Mesh(carGeometry, carMaterial);
            body.castShadow = body.receiveShadow = true;
            carGroup.add(body);

            // ËΩÆÂ≠êÔºà4Ôºâ
            var wheelGeometry = new THREE.BoxGeometry(0.1, 0.2, 0.2);
            var wheelMaterial = new THREE.MeshPhongMaterial({ color: 0x333333, shininess: 30, specular: 0x111111 });

            var frontLeftWheel = new THREE.Mesh(wheelGeometry, wheelMaterial);
            frontLeftWheel.position.set(-0.2, -0.35, 0.25);
            carGroup.add(frontLeftWheel);

            var frontRightWheel = new THREE.Mesh(wheelGeometry, wheelMaterial);
            frontRightWheel.position.set(0.2, -0.35, 0.25);
            carGroup.add(frontRightWheel);

            var backLeftWheel = new THREE.Mesh(wheelGeometry, wheelMaterial);
            backLeftWheel.position.set(-0.2, -0.35, -0.25);
            carGroup.add(backLeftWheel);

            var backRightWheel = new THREE.Mesh(wheelGeometry, wheelMaterial);
            backRightWheel.position.set(0.2, -0.35, -0.25);
            carGroup.add(backRightWheel);

            // Â∞èÈÖç‰ª∂ÔºàÁÅØÊù°„ÄÅÂ§©Á∫øÔºâ
            var lightBar = new THREE.Mesh(new THREE.BoxGeometry(0.4, 0.1, 0.1),
                new THREE.MeshPhongMaterial({ color: 0xffffff, emissive: 0x333333, emissiveIntensity: 0.5 }));
            lightBar.position.set(0, 0.3, 0);
            carGroup.add(lightBar);

            var antenna = new THREE.Mesh(new THREE.CylinderGeometry(0.01, 0.01, 0.1, 8), new THREE.MeshPhongMaterial({ color: 0x333333 }));
            antenna.position.set(0.2, 0.25, 0.2);
            carGroup.add(antenna);

            carGroup.up.set(0, 1, 0); // ÊòéÁ°Æ up ÂêëÈáè
            return carGroup;
        }

        var car = createCar();

        // Create a simple ground with grass texture
        var groundTexture = new THREE.TextureLoader().load('https://tse3-mm.cn.bing.net/th/id/OIP-C.T1tIeMTtO9O5vR3rrFZ-ngHaEK?rs=1&pid=ImgDetMain');
        groundTexture.wrapS = groundTexture.wrapT = THREE.RepeatWrapping; 
        groundTexture.repeat.set(200, 200); // Adjust based on your texture size

        var groundGeometry = new THREE.PlaneGeometry(2000, 2000);
        var groundMaterial = new THREE.MeshStandardMaterial({ 
    map: groundTexture,
    side: THREE.DoubleSide,
    roughness: 0.8,
    metalness: 0.2,
    emissive: 0x000000  // Á°Æ‰øùÊ≤°ÊúâËá™ÂèëÂÖâÂπ≤Êâ∞Èò¥ÂΩ±
});
        var ground = new THREE.Mesh(groundGeometry, groundMaterial);
        ground.rotation.x = Math.PI / 2;
        ground.position.y = -1;
        ground.receiveShadow = true;
        scene.add(ground);

        // Create airports with runways, terminals, and gates
        function createAirport(x, z, runwayRotation) {
            var airportGeometry = new THREE.BoxGeometry(0.000001, 0.000001, 0.000001);
            var airportMaterial = new THREE.MeshBasicMaterial({ color: 0x0000ff });
            var airport = new THREE.Mesh(airportGeometry, airportMaterial);
            airport.position.set(x, -0.95, z);
            scene.add(airport);

            // Load runway texture
            var runwayTexture = new THREE.TextureLoader().load('https://raw.githubusercontent.com/FlyComputerEric/3D-Airplane-Game/refs/heads/main/texture_runway.png');
            runwayTexture.wrapS = runwayTexture.wrapT = THREE.RepeatWrapping;
            runwayTexture.repeat.set(3.5, 1); // Adjust based on your texture aspect ratio
            
            // Create runway material
            var runwayMaterial = new THREE.MeshStandardMaterial({
                map: runwayTexture,
                side: THREE.DoubleSide,
                roughness: 0.7,
                metalness: 0.3
            });
            
            // Create runway mesh
            var runwayGeometry = new THREE.PlaneGeometry(20, 2);
            var runway = new THREE.Mesh(runwayGeometry, runwayMaterial);
            runway.rotation.x = Math.PI / 2;
            runway.rotation.z = runwayRotation;
            runway.position.set(x, -0.94, z + 10); // Adjust position to match the longer runway
            runway.receiveShadow = true;
            scene.add(runway);

            var terminalGeometry = new THREE.BoxGeometry(3, 1, 1);
            var terminalMaterial = new THREE.MeshPhongMaterial({ 
                color: 0x8B4513,
                shininess: 30,
                specular: 0x111111
            });
            var terminal = new THREE.Mesh(terminalGeometry, terminalMaterial);
            terminal.position.set(x + 4, 0, z + 2);
            terminal.castShadow = true;
            terminal.receiveShadow = true;
            scene.add(terminal);

            var gateGeometry = new THREE.BoxGeometry(0.5, 0.5, 0.5);
            var gateMaterial = new THREE.MeshPhongMaterial({ 
                color: 0xFFD700,
                shininess: 100,
                specular: 0x333333
            });
            var gate = new THREE.Mesh(gateGeometry, gateMaterial);
            gate.position.set(x + 4, 0.25, z + 3);
            gate.castShadow = true;
            gate.receiveShadow = true;
            scene.add(gate);
        }

        // Create tall and colorful buildings
        function createBuilding(x, z) {
            var height = Math.random() * 5 + 1;
            
            // Load building textures (front, side, top)
            var frontTexture = new THREE.TextureLoader().load('https://raw.githubusercontent.com/FlyComputerEric/3D-Airplane-Game/refs/heads/main/texture_building.jpg');
            var sideTexture = new THREE.TextureLoader().load('https://raw.githubusercontent.com/FlyComputerEric/3D-Airplane-Game/refs/heads/main/texture_building.jpg');
            var windowTexture = new THREE.TextureLoader().load('https://raw.githubusercontent.com/FlyComputerEric/3D-Airplane-Game/refs/heads/main/texture_building.jpg');
            
            // Configure texture repeating
            [frontTexture, sideTexture, windowTexture].forEach(tex => {
                tex.wrapS = tex.wrapT = THREE.RepeatWrapping;
                tex.repeat.set(1, Math.floor(height)); // Adjust based on building height
            });

            // Create materials for each face
            var materials = [
                new THREE.MeshStandardMaterial({ map: sideTexture, roughness: 0.7, metalness: 0.2 }), // Right side
                new THREE.MeshStandardMaterial({ map: sideTexture, roughness: 0.7, metalness: 0.2 }), // Left side
                new THREE.MeshStandardMaterial({ map: frontTexture, roughness: 0.7, metalness: 0.2 }), // Top
                new THREE.MeshStandardMaterial({ map: frontTexture, roughness: 0.7, metalness: 0.2 }), // Bottom
                new THREE.MeshStandardMaterial({ map: windowTexture, roughness: 0.5, metalness: 0.5 }), // Front
                new THREE.MeshStandardMaterial({ map: windowTexture, roughness: 0.5, metalness: 0.5 })  // Back
            ];

            var buildingGeometry = new THREE.BoxGeometry(1, height, 1);
            var building = new THREE.Mesh(buildingGeometry, materials);
            building.position.set(x, height / 2 - 1, z);
            
            // Enable shadows
            building.castShadow = true;
            building.receiveShadow = true;
            
            scene.add(building);
            return building;
        }

        // Create mountains
        function createMountain(x, z) {
            var height = Math.random() * 10 + 5;
            var mountainGeometry = new THREE.ConeGeometry(5, height, 32);
            var mountainMaterial = new THREE.MeshPhongMaterial({ 
                color: 0x8B4513,
                shininess: 10,
                specular: 0x111111
            });
            var mountain = new THREE.Mesh(mountainGeometry, mountainMaterial);
            mountain.position.set(x, height / 2 - 1, z);
            mountain.castShadow = true;
            mountain.receiveShadow = true;
            scene.add(mountain);
            return mountain;
        }

        // Create lakes - Fixed the black surface issue
        function createLake(x, z) {
            // Load water texture
            var waterTexture = new THREE.TextureLoader().load('https://img2.baidu.com/it/u=2639447110,2042750116&fm=253&fmt=auto&app=138&f=JPEG?w=500&h=667');
            waterTexture.wrapS = waterTexture.wrapT = THREE.RepeatWrapping;
            waterTexture.repeat.set(1, 1); // Adjust tiling based on your texture
            
            var lakeGeometry = new THREE.CircleGeometry(5, 32);
            var lakeMaterial = new THREE.MeshPhongMaterial({
                map: waterTexture,
                side: THREE.DoubleSide,
                shininess: 100, // High shininess for water
                specular: 0xffffff, // High specular reflection
                color: 0x0088ff, // Add a slight blue tint
                transparent: true,
                opacity: 0.9
            });
            
            var lake = new THREE.Mesh(lakeGeometry, lakeMaterial);
            lake.rotation.x = -Math.PI / 2;
            lake.position.set(x, -0.94, z); // Slightly above ground
            lake.receiveShadow = true;
            scene.add(lake);
            
            return lake;
        }

        // Function to create a cloud box
        function createCloud(x, y, z) {
            var cloudGeometry = new THREE.BoxGeometry(2, 1, 2); // Cloud shape
            var cloudMaterial = new THREE.MeshPhongMaterial({
                color: 0xffffff, // White color for clouds
                opacity: 0.8,
                transparent: true,
                shininess: 10,
                specular: 0xffffff
            });
            var cloud = new THREE.Mesh(cloudGeometry, cloudMaterial);
            cloud.position.set(x, y, z);
            cloud.castShadow = true;
            cloud.receiveShadow = true;
            scene.add(cloud);
            return cloud;
        }

        // Add multiple clouds to the scene
        for (let i = 0; i < 20; i++) {
            let x = Math.random() * 100 - 50; // Random X position
            let y = Math.random() * 20 + 20; // Random Y position (height)
            let z = Math.random() * 100 - 50; // Random Z position
            createCloud(x, y, z);
        }

        // Add multiple airports with runways, terminals, and gates
        for (let i = -5; i <= 5; i++) {
            for (let j = -5; j <= 5; j++) {
                var runwayRotation = (Math.random() < 0.5) ? 0 : Math.PI / 4; // Randomly set runway rotation to 0 or 45 degrees
                createAirport(i * 20, j * 20, runwayRotation);
            }
        }
        for (let i = 20; i <= 25; i++) {
            for (let j = 20; j <= 25; j++) {
                var runwayRotation = (Math.random() < 0.5) ? 0 : Math.PI / 4; // Randomly set runway rotation to 0 or 45 degrees
                createAirport(i * 20, j * 20, runwayRotation);
            }
        }

        // Set to track occupied positions
        var occupiedPositions = new Set();

        // Add tall and colorful buildings all over the map
        var buildings = [];
        for (let i = -25; i <= 25; i++) {
            for (let j = -25; j <= 25; j++) {
                if (Math.random() < 0.1) {
                    let x, z;
                    do {
                        x = i * 4;
                        z = j * 4;
                    } while (occupiedPositions.has(`${x},${z}`));
                    occupiedPositions.add(`${x},${z}`);
                    buildings.push(createBuilding(x, z));
                }
            }
        }

        // Add mountains and lakes
        var mountains = [];
        for (let i = -10; i <= 10; i++) {
            for (let j = -10; j <= 10; j++) {
                if (Math.random() < 0.05) {
                    mountains.push(createMountain(i * 20, j * 20));
                }
                if (Math.random() < 0.05) {
                    createLake(i * 20, j * 20);
                }
            }
        }
        for (let i = 16; i <= 32; i++) {
            for (let j = 16; j <= 32; j++) {
                if (Math.random() < 0.05) {
                    mountains.push(createMountain(i * 20, j * 20));
                }
                if (Math.random() < 0.05) {
                    createLake(i * 20, j * 20);
                }
            }
        }

        // Game variables
        
        var speed = 0;
        var vehicle = null;
        var crashed = false;
        var crashAnimationEnabled = false;
        var isPaused = false;
        var gameStartTime = 0;
        var score = 0;
        var currentVehicleType = ''; // Track current vehicle type
        
        // New: separate physical heading/pitch and visual rotation
        var headingAngle = 0;     // physics yaw (radians) - used for movement
        var pitchAngle = 0;       // physics pitch (radians) - used for movement vertical component
        var visualYaw = 0;        // visual yaw applied to mesh
        var visualPitch = 0;      // visual pitch applied to mesh
        var visualRoll = 0;       // visual roll applied to mesh
        var desiredRoll = 0;      // target roll when turning (smoothly interpolated)
        
        // Input key state for continuous control
        var keyState = {};
		
		        // Multiplayer variables
        var multiplayerEnabled = false;
        var playerName = 'Player';
        var aiPlayers = []; // AIÈ£ûÊú∫Êï∞ÁªÑ
        var missiles = []; // ÊâÄÊúâÂØºÂºπ
        var flares = []; // Èò≤Âæ°ÁÇÆÔºàÂπ≤Êâ∞ÂºπÔºâ
        var playerLives = 3;
        var playerMaxLives = 3;
        var playerScore = 0;
        var lastMissileTime = 0;
        var lastFlareTime = 0;
        var missileCooldown = 1500;
        var flareCooldown = 2500;
        var threatDetected = false;
        var enemyCloseDetected = false; // Êñ∞Â¢ûÔºöÊïå‰∫∫Êé•ËøëÊ£ÄÊµã
        var threatWarningEl = document.getElementById('threatWarning');
        var proximityWarningEl = document.getElementById('proximityWarning'); // Êñ∞Â¢û
        var playerLivesEl = document.getElementById('playerLives');
        var playerScoreEl = document.getElementById('playerScore');
        var invincibilityIndicator = document.getElementById('invincibilityIndicator');
        
        // Invincibility variables
        var invincible = false;
        var invincibilityTimer = 0;
        var invincibilityDuration = 300;
        
        // AI settings
        var aiCount = 5;
        var aiRespawnPositions = [
            {x: 20, y: 5, z: 20},
            {x: -20, y: 8, z: -20},
            {x: 30, y: 6, z: -30},
            {x: -30, y: 7, z: 30},
            {x: 40, y: 10, z: 40}
        ];
		        // ========== AI FUNCTIONS ==========
        
        // Create AI airplane with lives tracking
        function createAIPlane(color, startPos, index) {
            var plane = createAirplane(color);
            plane.position.set(startPos.x, startPos.y, startPos.z);
            plane.castShadow = true;
            plane.receiveShadow = true;
            
            // Store AI data
            var aiData = {
                mesh: plane,
                lives: 3,
                maxLives: 3,
                index: index,
                target: null,
                speed: 0.08 + Math.random() * 0.05,
                headingAngle: Math.random() * Math.PI * 2,
                pitchAngle: (Math.random() - 0.5) * 0.3,
                rollAngle: 0,
                attackCooldown: 0,
                flareCooldown: 0,
                behavior: 'patrol',
                lastTargetPos: new THREE.Vector3(),
                respawnTimer: 0
            };
            
            // Add name tag
            var canvas = document.createElement('canvas');
            canvas.width = 128;
            canvas.height = 64;
            var ctx = canvas.getContext('2d');
            ctx.fillStyle = 'rgba(0,0,0,0.5)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.font = 'bold 20px Arial';
            ctx.fillStyle = 'white';
            ctx.textAlign = 'center';
            ctx.fillText('AI ' + (index + 1), canvas.width/2, 35);
            
            // Add life indicators
            ctx.fillStyle = 'red';
            ctx.fillRect(20, 45, 20, 10);
            ctx.fillStyle = 'green';
            ctx.fillRect(20, 45, 20 * (aiData.lives / 3), 10);
            
            var texture = new THREE.CanvasTexture(canvas);
            var material = new THREE.SpriteMaterial({ map: texture });
            var sprite = new THREE.Sprite(material);
            sprite.scale.set(1.5, 0.75, 1);
            sprite.position.set(0, 1.8, 0);
            plane.add(sprite);
            
            scene.add(plane);
            return aiData;
        }
        
        // Create a missile (ËøΩË∏™ÂØºÂºπ)
        function createMissile(position, direction, owner, isAIMissile = false) {
            var missileGroup = new THREE.Group();
            
            var bodyGeo = new THREE.CylinderGeometry(0.15, 0.15, 0.8);
            var bodyMat = new THREE.MeshPhongMaterial({ color: 0xff6600, emissive: 0x442200 });
            var body = new THREE.Mesh(bodyGeo, bodyMat);
            body.rotation.x = Math.PI / 2;
            body.castShadow = true;
            missileGroup.add(body);
            
            var tipGeo = new THREE.ConeGeometry(0.2, 0.4);
            var tipMat = new THREE.MeshPhongMaterial({ color: 0xff0000, emissive: 0x330000 });
            var tip = new THREE.Mesh(tipGeo, tipMat);
            tip.position.set(0, 0, 0.5);
            missileGroup.add(tip);
            
            var finGeo = new THREE.BoxGeometry(0.4, 0.05, 0.15);
            var finMat = new THREE.MeshPhongMaterial({ color: 0xcccccc });
            
            for (var i = 0; i < 4; i++) {
                var fin = new THREE.Mesh(finGeo, finMat);
                var angle = (i * Math.PI / 2);
                fin.position.set(Math.cos(angle) * 0.25, Math.sin(angle) * 0.25, -0.3);
                fin.rotation.z = angle;
                missileGroup.add(fin);
            }
            
            var trailGeo = new THREE.SphereGeometry(0.1, 4);
            var trailMat = new THREE.MeshPhongMaterial({ color: 0xffaa00, emissive: 0xff4400 });
            var trail = new THREE.Mesh(trailGeo, trailMat);
            trail.position.set(0, 0, -0.5);
            missileGroup.add(trail);
            
            missileGroup.position.copy(position);
            
            var missileData = {
                mesh: missileGroup,
                direction: direction.clone().normalize(),
                speed: 0.25,
                owner: owner,
                isAIMissile: isAIMissile,
                target: null,
                turnRate: 0.03,
                age: 0,
                maxAge: 300
            };
            
            scene.add(missileGroup);
            return missileData;
        }
        
        // Create a flare (Èò≤Âæ°ÁÇÆ/Âπ≤Êâ∞Âºπ)
        function createFlare(position, direction, owner) {
            var flareGroup = new THREE.Group();
            
            var bodyGeo = new THREE.SphereGeometry(0.2, 8);
            var bodyMat = new THREE.MeshPhongMaterial({ color: 0xffff00, emissive: 0xffaa00 });
            var body = new THREE.Mesh(bodyGeo, bodyMat);
            flareGroup.add(body);
            
            var glowGeo = new THREE.SphereGeometry(0.3, 8);
            var glowMat = new THREE.MeshPhongMaterial({ color: 0xffaa00, emissive: 0xff4400, transparent: true, opacity: 0.5 });
            var glow = new THREE.Mesh(glowGeo, glowMat);
            flareGroup.add(glow);
            
            flareGroup.position.copy(position);
            
            var flareData = {
                mesh: flareGroup,
                position: position.clone(),
                direction: direction.clone().normalize(),
                speed: 0.35,
                owner: owner,
                targetMissile: null,
                age: 0,
                maxAge: 120,
                blastRadius: 5
            };
            
            scene.add(flareGroup);
            return flareData;
        }
        
        // Update AI behavior
        function updateAI() {
            var time = Date.now() * 0.001;
            
            for (var i = aiPlayers.length - 1; i >= 0; i--) {
                var ai = aiPlayers[i];
                
                if (ai.lives <= 0) {
                    if (!ai.respawnTimer) {
                        if (ai.mesh.parent) scene.remove(ai.mesh);
                        ai.respawnTimer = 180;
                    } else {
                        ai.respawnTimer--;
                        if (ai.respawnTimer <= 0) {
                            var pos = aiRespawnPositions[i % aiRespawnPositions.length];
                            ai.mesh.position.set(pos.x, pos.y, pos.z);
                            ai.lives = 3;
                            ai.respawnTimer = 0;
                            ai.behavior = 'patrol';
                            scene.add(ai.mesh);
                        }
                    }
                    continue;
                }
                
                if (ai.attackCooldown > 0) ai.attackCooldown--;
                if (ai.flareCooldown > 0) ai.flareCooldown--;
                
                var closestTarget = null;
                var closestDist = 100;
                
                if (vehicle && !crashed) {
                    var distToPlayer = ai.mesh.position.distanceTo(vehicle.position);
                    if (distToPlayer < closestDist) {
                        closestDist = distToPlayer;
                        closestTarget = { type: 'player', obj: vehicle, pos: vehicle.position };
                    }
                }
                
                for (var j = 0; j < aiPlayers.length; j++) {
                    if (i === j) continue;
                    var other = aiPlayers[j];
                    if (other.lives <= 0) continue;
                    var dist = ai.mesh.position.distanceTo(other.mesh.position);
                    if (dist < closestDist && dist < 60) {
                        closestDist = dist;
                        closestTarget = { type: 'ai', obj: other.mesh, pos: other.mesh.position, aiData: other };
                    }
                }
                
                if (closestTarget && closestDist < 50) {
                    ai.behavior = 'attack';
                    ai.target = closestTarget;
                    
                    if (closestDist < 40 && ai.attackCooldown <= 0 && Math.random() < 0.02) {
                        var dir = new THREE.Vector3().subVectors(closestTarget.pos, ai.mesh.position).normalize();
                        var missile = createMissile(ai.mesh.position.clone().add(dir.clone().multiplyScalar(2)), dir, ai, true);
                        missile.target = closestTarget;
                        missiles.push(missile);
                        ai.attackCooldown = 60;
                    }
                    
                    if (ai.flareCooldown <= 0 && Math.random() < 0.01) {
                        var flareDir = new THREE.Vector3(Math.random()-0.5, Math.random()-0.5, Math.random()-0.5).normalize();
                        var flare = createFlare(ai.mesh.position, flareDir, ai);
                        flares.push(flare);
                        ai.flareCooldown = 90;
                    }
                } else {
                    ai.behavior = 'patrol';
                    ai.target = null;
                }
                
                if (ai.behavior === 'attack' && ai.target) {
                    var targetDir = new THREE.Vector3().subVectors(ai.target.pos, ai.mesh.position).normalize();
                    var currentDir = new THREE.Vector3(Math.sin(ai.headingAngle), 0, Math.cos(ai.headingAngle));
                    
                    var angleToTarget = Math.atan2(targetDir.x, targetDir.z);
                    var angleDiff = angleToTarget - ai.headingAngle;
                    while (angleDiff > Math.PI) angleDiff -= 2*Math.PI;
                    while (angleDiff < -Math.PI) angleDiff += 2*Math.PI;
                    
                    ai.headingAngle += angleDiff * 0.03;
                    
                    var targetY = ai.target.pos.y;
                    var dy = targetY - ai.mesh.position.y;
                    ai.pitchAngle += (dy * 0.01 - ai.pitchAngle) * 0.02;
                    ai.pitchAngle = Math.max(-0.3, Math.min(0.3, ai.pitchAngle));
                } else {
                    ai.headingAngle += (Math.sin(time * 0.5 + i) * 0.02 - ai.headingAngle * 0.01);
                    ai.pitchAngle += (Math.sin(time * 0.3 + i) * 0.1 - ai.pitchAngle) * 0.01;
                }
                
                var pos = ai.mesh.position;
                var bound = 80;
                if (Math.abs(pos.x) > bound) {
                    ai.headingAngle = Math.atan2(-pos.x, pos.z);
                }
                if (Math.abs(pos.z) > bound) {
                    ai.headingAngle = Math.atan2(pos.x, -pos.z);
                }
                if (pos.y < 5) {
                    pos.y = 5;
                    ai.pitchAngle = 0.1;
                }
                if (pos.y > 30) {
                    pos.y = 30;
                    ai.pitchAngle = -0.1;
                }
                
                var moveDir = new THREE.Vector3(
                    Math.sin(ai.headingAngle),
                    Math.sin(ai.pitchAngle),
                    Math.cos(ai.headingAngle)
                ).normalize();
                
                ai.mesh.position.addScaledVector(moveDir, ai.speed);
                
                ai.mesh.quaternion.setFromEuler(new THREE.Euler(
                    -ai.pitchAngle,
                    ai.headingAngle,
                    (ai.behavior === 'attack' ? Math.sin(time * 5 + i) * 0.2 : 0),
                    'YXZ'
                ));
            }
        }
        
        // Update missiles and check collisions
                // Update missiles and check collisions
                // Update missiles and check collisions
        function updateMissilesAndFlares() {
            threatDetected = false;
            enemyCloseDetected = false; // ÈáçÁΩÆÊïå‰∫∫Êé•ËøëÊ£ÄÊµã
            
            // Ê£ÄÊü•ÊòØÂê¶ÊúâÊïå‰∫∫È£ûÊú∫Êé•Ëøë
            if (vehicle && multiplayerEnabled) {
                for (var e = 0; e < aiPlayers.length; e++) {
                    var enemy = aiPlayers[e];
                    if (enemy.lives <= 0) continue;
                    
                    // Ê£ÄÊµãÊïå‰∫∫È£ûÊú∫Ë∑ùÁ¶ªÔºà20Âçï‰Ωç‰ª•ÂÜÖÔºâ
                    var distToEnemy = vehicle.position.distanceTo(enemy.mesh.position);
                    if (distToEnemy < 20) {
                        enemyCloseDetected = true;
                        break;
                    }
                }
            }
            
            // Êõ¥Êñ∞Êé•ËøëË≠¶ÂëäÊòæÁ§∫
            if (proximityWarningEl) {
                if (enemyCloseDetected && multiplayerEnabled && !crashed && !isPaused) {
                    proximityWarningEl.classList.remove('hidden');
                } else {
                    proximityWarningEl.classList.add('hidden');
                }
            }
            
            // Update missiles
            for (var i = missiles.length - 1; i >= 0; i--) {
                var m = missiles[i];
                m.age++;
                
                if (!m.target || (m.target.type === 'player' && (!vehicle || crashed)) || 
                    (m.target.type === 'ai' && m.target.aiData && m.target.aiData.lives <= 0)) {
                    var closestDist = 100;
                    var newTarget = null;
                    
                    if (vehicle && !crashed) {
                        var dist = m.mesh.position.distanceTo(vehicle.position);
                        if (dist < closestDist) {
                            closestDist = dist;
                            newTarget = { type: 'player', obj: vehicle, pos: vehicle.position };
                        }
                    }
                    
                    for (var a = 0; a < aiPlayers.length; a++) {
                        var ai = aiPlayers[a];
                        if (ai.lives <= 0) continue;
                        var dist = m.mesh.position.distanceTo(ai.mesh.position);
                        if (dist < closestDist) {
                            closestDist = dist;
                            newTarget = { type: 'ai', obj: ai.mesh, pos: ai.mesh.position, aiData: ai };
                        }
                    }
                    
                    m.target = newTarget;
                }
                
                // Turn towards target
                if (m.target) {
                    var targetPos = m.target.pos;
                    var dirToTarget = new THREE.Vector3().subVectors(targetPos, m.mesh.position).normalize();
                    m.direction.lerp(dirToTarget, m.turnRate).normalize();
                    
                    // Threat warning for player - Âè™ÊúâÂØºÂºπË∑ùÁ¶ªÁé©ÂÆ∂20Âçï‰Ωç‰ª•ÂÜÖÊâçË≠¶Âëä
                    if (m.target.type === 'player' && m.mesh.position.distanceTo(vehicle.position) < 20) {
                        threatDetected = true;
                    }
                }
                
                m.mesh.position.addScaledVector(m.direction, m.speed);
                
                if (m.age > m.maxAge || m.mesh.position.y < -1) {
                    scene.remove(m.mesh);
                    missiles.splice(i, 1);
                    continue;
                }
                
                var hit = false;
                
                // Player collision - only if not invincible
                if (vehicle && !crashed && m.owner !== 'player' && m.mesh.position.distanceTo(vehicle.position) < 2.5) {
                    if (!invincible) {
                        playerLives--;
                        if (playerLivesEl) playerLivesEl.textContent = playerLives;
                        
                        if (playerLives <= 0) {
                            crashed = true;
                            setTimeout(showGameOverScreen, 500);
                        } else {
                            // Flash damage effect
                            vehicle.material.emissive = new THREE.Color(0xff0000);
                            setTimeout(() => { if (vehicle) vehicle.material.emissive = new THREE.Color(0x000000); }, 200);
                        }
                        hit = true;
                    } else {
                        // Êó†ÊïåÁä∂ÊÄÅÔºöÂèçÂºπÂØºÂºπÊïàÊûú
                        var bounceDir = m.direction.clone().negate();
                        m.direction = bounceDir;
                        // Ê∑ªÂä†Èó™ÂÖâÊïàÊûúË°®Á§∫ÂèçÂºπ
                        if (vehicle) {
                            vehicle.material.emissive = new THREE.Color(0xffff00);
                            setTimeout(() => { if (vehicle) vehicle.material.emissive = new THREE.Color(0x000000); }, 100);
                        }
                    }
                }
                
                // AI collision - Á°Æ‰øùÂàÜÊï∞Âè™Âä†ÁªôÁé©ÂÆ∂Âáª‰∏≠ÁöÑAI
                for (var a = 0; a < aiPlayers.length; a++) {
                    var ai = aiPlayers[a];
                    if (ai.lives <= 0) continue;
                    if (m.mesh.position.distanceTo(ai.mesh.position) < 2.5) {
                        // Âè™ÊúâÁé©ÂÆ∂ÂèëÂ∞ÑÁöÑÂØºÂºπÂáª‰∏≠AIÊâçÂä†ÂàÜ
                        if (m.owner === 'player') {
                            ai.lives--;
                            playerScore += 500;
                            if (playerScoreEl) playerScoreEl.textContent = playerScore;
                        } else {
                            // AI‰πãÈó¥ÁöÑ‰∫íÁõ∏ÊîªÂáªÔºåÂè™Êâ£ÂëΩ‰∏çÂä†ÂàÜ
                            ai.lives--;
                        }
                        hit = true;
                        break;
                    }
                }
                
                if (hit) {
                    var expGeo = new THREE.SphereGeometry(0.8, 8);
                    var expMat = new THREE.MeshPhongMaterial({ color: 0xff6600, emissive: 0xff2200 });
                    var exp = new THREE.Mesh(expGeo, expMat);
                    exp.position.copy(m.mesh.position);
                    scene.add(exp);
                    setTimeout(() => scene.remove(exp), 200);
                    
                    scene.remove(m.mesh);
                    missiles.splice(i, 1);
                }
            }
            
            for (var i = flares.length - 1; i >= 0; i--) {
                var f = flares[i];
                f.age++;
                
                f.mesh.position.addScaledVector(f.direction, f.speed);
                f.mesh.scale.multiplyScalar(0.98);
                
                for (var j = missiles.length - 1; j >= 0; j--) {
                    var m = missiles[j];
                    if (f.mesh.position.distanceTo(m.mesh.position) < f.blastRadius) {
                        scene.remove(m.mesh);
                        missiles.splice(j, 1);
                        
                        var expGeo = new THREE.SphereGeometry(1, 8);
                        var expMat = new THREE.MeshPhongMaterial({ color: 0xffff00, emissive: 0xffaa00 });
                        var exp = new THREE.Mesh(expGeo, expMat);
                        exp.position.copy(f.mesh.position);
                        scene.add(exp);
                        setTimeout(() => scene.remove(exp), 200);
                        
                        break;
                    }
                }
                
                if (f.age > f.maxAge || f.mesh.scale.x < 0.1) {
                    scene.remove(f.mesh);
                    flares.splice(i, 1);
                }
            }
            
            if (threatWarningEl) {
                if (threatDetected) {
                    threatWarningEl.classList.remove('hidden');
                } else {
                    threatWarningEl.classList.add('hidden');
                }
            }
        }
        
        // ========== AI FUNCTIONS END ==========
        
        // ========== AI FUNCTIONS END ==========
               // UI Elements
        const menu = document.getElementById('menu');
        const hud = document.getElementById('hud');
        const escMenu = document.getElementById('escMenu');
        const gameOverScreen = document.getElementById('gameOverScreen');
        const finalScoreElement = document.getElementById('finalScore');
        const currentVehicleElement = document.getElementById('currentVehicle');
        const speedElement = document.getElementById('speed');
        const altitudeElement = document.getElementById('altitude');
        const headingElement = document.getElementById('heading');
        const speedLargeElement = document.getElementById('speedLarge');
        const altitudeLargeElement = document.getElementById('altitudeLarge');
        const compassNeedle = document.getElementById('compassNeedle');
        const controlsModal = document.getElementById('controlsModal');
		
        // Helper function to normalize angles to [-PI, PI]
        function normalizeAngle(a) {
            a = (a + Math.PI) % (2 * Math.PI);
            if (a < 0) a += 2 * Math.PI;
            return a - Math.PI;
        }

        // Helper: shortest angle difference
        function angleDiff(a, b) {
            var d = normalizeAngle(a - b);
            return d;
        }

        // ---------------- Adjusted parameters ----------------
        // Reduced speeds/animation as requested
        var yawRate = 0.012;      // reduced yaw (turning) speed (physical)
        var pitchRate = 0.008;    // reduced pitch rate (physical) ‚Äî S up / W down mapping below
        var maxPitch = 0.6;       // max physical pitch
        var rollAmount = 0.5;     // reduced visual roll amplitude
        // visual follow (smoothing) - lower values = slower animation
        var visualYawFollow = 0.04;
        var visualPitchFollow = 0.04;
        var visualRollFollow = 0.06;

        
        // Animation loop
        function animate() {
			requestAnimationFrame(animate);
            
            // Update invincibility timer
            if (invincible && invincibilityTimer > 0) {
                invincibilityTimer--;
                if (invincibilityTimer <= 0) {
                    invincible = false;
                    if (invincibilityIndicator) {
                        invincibilityIndicator.classList.add('hidden');
                    }
                    // ÊÅ¢Â§çÈ£ûÊú∫ÊùêË¥®
                    if (vehicle && vehicle.material) {
                        vehicle.material.emissive = new THREE.Color(0x000000);
                    }
                }
            }
            if (vehicle && !crashed && !isPaused) {
                // Input handling (continuous)

                // Left/right turning controls
                // Fix: A => turn left; D => turn right
                if (keyState['a']) {
                    headingAngle += yawRate;        // left = decrease headingAngle
                    desiredRoll = -rollAmount;      // visual roll left (negative)
                } else if (keyState['d']) {
                    headingAngle -= yawRate;        // right = increase headingAngle
                    desiredRoll = rollAmount;       // visual roll right (positive)
                } else {
                    desiredRoll = THREE.MathUtils.lerp(desiredRoll, 0, 0.08);
                }

                // Pitch controls: per your request swap mapping:
                // S => ascend (increase pitchAngle -> positive upward movement)
                // W => descend (decrease pitchAngle -> negative movement)
                if (keyState['s']) {
                    pitchAngle = THREE.MathUtils.clamp(pitchAngle + pitchRate, -maxPitch, maxPitch);
                } else if (keyState['w']) {
                    pitchAngle = THREE.MathUtils.clamp(pitchAngle - pitchRate, -maxPitch, maxPitch);
                } else {
                    pitchAngle = THREE.MathUtils.lerp(pitchAngle, 0, 0.02);
                }

                // Update score based on time and speed
                if (gameStartTime > 0) {
                    const gameTime = (Date.now() - gameStartTime) / 1000;
                    score = Math.floor(gameTime * (speed * 100));
                }

                // Compute forward direction from headingAngle & pitchAngle (movement independent of mesh quaternion)
                var forwardDirection = new THREE.Vector3(
                    Math.sin(headingAngle),
                    Math.sin(pitchAngle),
                    Math.cos(headingAngle)
                );
                forwardDirection.normalize();

                // Apply movement
                if (currentVehicleType === 'car') {
                    // Cars stay on the ground: zero Y movement
                    forwardDirection.y = 0;
                    if (forwardDirection.lengthSq() > 0.000001) forwardDirection.normalize();
                    vehicle.position.addScaledVector(forwardDirection, speed);

                    // Visual yaw for car should reflect heading for appearance
                    var dYaw = angleDiff(headingAngle, visualYaw);
                    visualYaw += dYaw * 0.15;
                    visualPitch = THREE.MathUtils.lerp(visualPitch, 0, 0.1);
                    visualRoll = THREE.MathUtils.lerp(visualRoll, 0, 0.1);

                    vehicle.quaternion.setFromEuler(new THREE.Euler(visualPitch, visualYaw, visualRoll, 'YXZ'));

                    // Keep car on ground
                    vehicle.position.y = Math.max(vehicle.position.y, 0);
                } else {
                    // Airplane moves in 3D according to headingAngle/pitchAngle
                    vehicle.position.addScaledVector(forwardDirection, speed);

                    // Visual smoothing:
                    // Important fix: visualPitch should be the negative of physical pitchAngle so that visual nose direction matches movement:
                    // physical pitchAngle positive => upward movement; to make model nose point upward visually, set visualPitch ~= -pitchAngle (three.js positive rotation around X results in nose-down)
                    var dYawPlane = angleDiff(headingAngle, visualYaw);
                    visualYaw += dYawPlane * visualYawFollow;                 // slower yaw visual follow
                    visualPitch = THREE.MathUtils.lerp(visualPitch, -pitchAngle, visualPitchFollow); // invert for correct nose direction
                    visualRoll = THREE.MathUtils.lerp(visualRoll, desiredRoll, visualRollFollow);

                    vehicle.quaternion.setFromEuler(new THREE.Euler(visualPitch, visualYaw, visualRoll, 'YXZ'));
                }

                // Check for crash with the ground
                if (vehicle.position.y < -0.95) {
                    if (crashAnimationEnabled) {
                        triggerCrashAnimation();
                    }
                }

                // Check for crash with buildings
                for (let building of buildings) {
                    if (vehicle.position.distanceTo(building.position) < 2.2) {
                        if (crashAnimationEnabled) {
                            triggerCrashAnimation();
                        }
                        break;
                    }
                }

                // Check for crash with mountains
                for (let mountain of mountains) {
                    if (vehicle.position.distanceTo(mountain.position) < 6.5) {
                        if (crashAnimationEnabled) {
                            triggerCrashAnimation();
                        }
                        break;
                    }
                }

                // Update camera positions based on vehicle position and rotation
                updateCameraPositions();

                // Calculate heading in degrees (0-359) from headingAngle (physical)
                let headingDegrees = Math.abs(((-headingAngle * 180 / Math.PI) % 360 + 360) % 360);

                // Update HUD
                updateHUD(headingDegrees);
                // Update compass needle rotation
if (compassNeedle) {
    // ÁßªÈô§ translate(-50%, -50%)ÔºåÂõ†‰∏∫ SVG Â∑≤ÁªèÊ≠£Á°ÆÂ±Ö‰∏≠
    compassNeedle.style.transform = `rotate(${headingDegrees}deg)`;
}
            }
                // Update multiplayer AI
            if (multiplayerEnabled) {
                updateAI();
                updateMissilesAndFlares();
                
                // Update HUD counts
                var aliveAI = aiPlayers.filter(ai => ai.lives > 0).length;
                document.getElementById('onlinePlayersCount').textContent = aliveAI;
            }
            
            renderer.render(scene, currentCamera);
        }
		
        // Update camera positions based on vehicle position and rotation
        function updateCameraPositions() {
            if (!vehicle) return;
            
            // Main external camera
            const offset = new THREE.Vector3(0, 2, -5); // Offset from the vehicle
            offset.applyQuaternion(vehicle.quaternion); // Rotate the offset based on the vehicle's visual rotation
            camera.position.copy(vehicle.position.clone().add(offset)); // Set camera position relative to the vehicle
            camera.lookAt(vehicle.position); // Make the camera look at the vehicle

            // Cockpit camera (inside the vehicle)
            cockpitCamera.position.copy(vehicle.position.clone().add(new THREE.Vector3(0, 0.5, 0.6))); // Adjust position to be inside the cockpit and forward
            const cockpitLookAt = new THREE.Vector3(0, 0, 2).applyQuaternion(vehicle.quaternion); // Forward direction based on vehicle visual rotation
            cockpitCamera.lookAt(vehicle.position.clone().add(cockpitLookAt)); // Make the cockpit camera look forward

            // Wing camera (view from the wing)
            const leftWingPosition = new THREE.Vector3(-1, 1, -1); // Position relative to the vehicle
            leftWingPosition.applyQuaternion(vehicle.quaternion); // Apply the vehicle's rotation
            wingCamera.position.copy(vehicle.position.clone().add(leftWingPosition)); // Set wing camera position on the wing
            const wingLookAt = new THREE.Vector3(-1, 0, 3).applyQuaternion(vehicle.quaternion); // Look slightly outward from the wing
            wingCamera.lookAt(vehicle.position.clone().add(wingLookAt)); // Make the wing camera look outward

            // Gear camera (view from below)
            const gearPosition = new THREE.Vector3(0, -0.6, -1); // Position below the vehicle
            gearPosition.applyQuaternion(vehicle.quaternion); // Apply the vehicle's rotation
            gearCamera.position.copy(vehicle.position.clone().add(gearPosition)); // Set gear camera position below the vehicle
            const gearLookAt = new THREE.Vector3(0, 0, 5).applyQuaternion(vehicle.quaternion); // Look at the vehicle body
            gearCamera.lookAt(vehicle.position.clone().add(gearLookAt)); // Make the gear camera look at the vehicle
        }

        // Update HUD elements
        function updateHUD(headingDegrees) {
            if (!vehicle) return;
            // Update basic flight data
            speedElement.textContent = (speed * 100).toFixed(2);
            altitudeElement.textContent = vehicle.position.y.toFixed(2);
            headingElement.textContent = headingDegrees.toFixed(2) + '¬∞';
            
            // Update large displays
            speedLargeElement.textContent = Math.floor(speed * 100);
            altitudeLargeElement.textContent = Math.floor(vehicle.position.y);
            
            // Update compass needle rotation
            if (compassNeedle) compassNeedle.style.transform = `translate(-50%, -50%) rotate(${headingDegrees}deg)`;
        }

        // Trigger crash animation
        function triggerCrashAnimation() {
            // Create explosion effect
            var explosionGeometry = new THREE.SphereGeometry(1, 32, 32);
            var explosionMaterial = new THREE.MeshPhongMaterial({ 
                color: 0xff0000,
                emissive: 0xff4400,
                emissiveIntensity: 0.8,
                transparent: true,
                opacity: 0.8
            });
            var explosion = new THREE.Mesh(explosionGeometry, explosionMaterial);
            explosion.position.copy(vehicle.position);
            scene.add(explosion);

            // Animate explosion
            if (typeof gsap !== 'undefined') {
                gsap.to(explosion.scale, {
                    x: 3,
                    y: 3,
                    z: 3,
                    duration: 0.5,
                    ease: "power2.out"
                });
                
                gsap.to(explosion.material, {
                    opacity: 0,
                    duration: 0.5,
                    delay: 0.2,
                    onComplete: function() {
                        scene.remove(explosion);
                    }
                });
            } else {
                // Fallback animation without GSAP
                setTimeout(() => {
                    scene.remove(explosion);
                }, 700);
            }

            speed = 0; // Stop the vehicle
            crashed = true;
            
            // Show game over screen after a short delay
            setTimeout(() => {
                showGameOverScreen();
            }, 800);
        }

        // Show game over screen
        function showGameOverScreen() {
            if (!finalScoreElement) return;
            // ‰ΩøÁî®playerScoreËÄå‰∏çÊòØscoreÔºåÁ°Æ‰øùÂàÜÊï∞Ê≠£Á°Æ
            finalScoreElement.textContent = playerScore;
            gameOverScreen.style.opacity = '1';
            gameOverScreen.style.pointerEvents = 'auto';
            var glass = gameOverScreen.querySelector('.glass-effect');
            if (glass) glass.style.transform = 'scale(1)';
        }

        // Hide game over screen
        function hideGameOverScreen() {
            gameOverScreen.style.opacity = '0';
            gameOverScreen.style.pointerEvents = 'none';
            var glass = gameOverScreen.querySelector('.glass-effect');
            if (glass) glass.style.transform = 'scale(0.95)';
        }

        // Toggle pause menu
        function togglePause() {
            isPaused = !isPaused;

            if (isPaused) {
                escMenu.style.opacity = '1';
                escMenu.style.pointerEvents = 'auto';
                var glass = escMenu.querySelector('.glass-effect');
                if (glass) glass.style.transform = 'scale(1)';
            } else {
                escMenu.style.opacity = '0';
                escMenu.style.pointerEvents = 'none';
                var glass = escMenu.querySelector('.glass-effect');
                if (glass) glass.style.transform = 'scale(0.95)';
            }
        }

        // Restart the game
        function restartGame() {
        	 // Clear all projectiles
            missiles.forEach(m => scene.remove(m.mesh));
            missiles = [];
            flares.forEach(f => scene.remove(f.mesh));
            flares = [];
            
            // Remove AI
            aiPlayers.forEach(ai => {
                if (ai.mesh.parent) scene.remove(ai.mesh);
            });
            aiPlayers = [];
            
            // Reset player stats
            playerLives = 3; // Êîπ‰∏∫5Êù°ÂëΩ
            playerScore = 0; // ÈáçÁΩÆÂàÜÊï∞
            if (playerLivesEl) playerLivesEl.textContent = playerLives;
            if (playerScoreEl) playerScoreEl.textContent = playerScore;
            
            // Reset invincibility
            invincible = false;
            invincibilityTimer = 0;
            if (invincibilityIndicator) {
                invincibilityIndicator.classList.add('hidden');
            }
            
            // Hide menus
            hideGameOverScreen();
            if (isPaused) togglePause();
            
            // Remove current vehicle
            if (vehicle) {
                scene.remove(vehicle);
                vehicle = null;
            }
            
            // Get selected vehicle and start position
            const selectedVehicle = document.getElementById('vehicleSelect').value;
            const startPosition = 'runway';
            
            // Start game
            startGameWithSettings(selectedVehicle, startPosition);
            
            // Reinitialize AI if multiplayer enabled
            if (multiplayerEnabled && playerName) {
                setTimeout(() => {
                    for (var i = 0; i < aiCount; i++) {
                        var pos = aiRespawnPositions[i % aiRespawnPositions.length];
                        var colors = [0xff3333, 0x33ff33, 0x3333ff, 0xffff33, 0xff33ff];
                        var ai = createAIPlane(colors[i % colors.length], 
                            new THREE.Vector3(pos.x + Math.random()*5, pos.y, pos.z + Math.random()*5), i);
                        aiPlayers.push(ai);
                    }
                }, 500);
            }
           
        }

        // Return to main menu
                // Return to main menu
        function returnToMenu() {
            // ÈöêËóèÊâÄÊúâAIÁõ∏ÂÖ≥ÁöÑHUDÂÖÉÁ¥†
            const livesDisplay = document.getElementById('livesDisplay');
            const threatWarning = document.getElementById('threatWarning');
            const invincibilityInd = document.getElementById('invincibilityIndicator');
            const proximityWarning = document.getElementById('proximityWarning');
            
            if (livesDisplay) livesDisplay.classList.add('hidden');
            if (threatWarning) threatWarning.classList.add('hidden');
            if (invincibilityInd) invincibilityInd.classList.add('hidden');
            if (proximityWarning) proximityWarning.classList.add('hidden');
            
            // Reset invincibility
            invincible = false;
            invincibilityTimer = 0;
            
            // Reset game state
            crashed = false;
            speed = 0;
            score = 0;
            isPaused = false;
            
            // Hide all screens
            hideGameOverScreen();
            escMenu.style.opacity = '0';
            escMenu.style.pointerEvents = 'none';
            var glass = escMenu.querySelector('.glass-effect');
            if (glass) glass.style.transform = 'scale(0.95)';
            
            // Hide HUD
            hud.style.opacity = '0';
            
            // Show main menu
            menu.style.display = 'flex';
            
            // Remove current vehicle
            if (vehicle) {
                scene.remove(vehicle);
                vehicle = null;
            }
        }

        // Switch camera view
        function switchCamera(cameraIndex) {
            currentCameraIndex = cameraIndex;
            
            switch (cameraIndex) {
                case 0:
                    currentCamera = camera;
                    break;
                case 1:
                    currentCamera = cockpitCamera;
                    break;
                case 2:
                    currentCamera = wingCamera;
                    break;
                case 3:
                    currentCamera = gearCamera;
                    break;
            }
            
            // Update camera buttons
            document.querySelectorAll('.camera-btn').forEach((btn, index) => {
                if (index === cameraIndex) {
                    btn.classList.add('text-accent');
                    btn.classList.remove('text-white');
                } else {
                    btn.classList.remove('text-accent');
                    btn.classList.add('text-white');
                }
            });
        }

        // Show controls modal
        function showControlsModal() {
            controlsModal.style.opacity = '1';
            controlsModal.style.pointerEvents = 'auto';
            var glass = controlsModal.querySelector('.glass-effect');
            if (glass) glass.style.transform = 'scale(1)';
        }

        // Hide controls modal
        function hideControlsModal() {
            controlsModal.style.opacity = '0';
            controlsModal.style.pointerEvents = 'none';
            var glass = controlsModal.querySelector('.glass-effect');
            if (glass) glass.style.transform = 'scale(0.95)';
        }

        // Start game with selected settings
        function startGameWithSettings(vehicleType, startPosition) {
            // Hide the menu
            menu.style.display = 'none';
            
            // Show the HUD with fade-in effect
            setTimeout(() => {
                hud.style.opacity = '1';
            }, 100);
            
            crashAnimationEnabled = document.getElementById('crashAnimationCheckbox').checked;
            crashed = false;
            isPaused = false;
            gameStartTime = Date.now();
            
            // Track current vehicle type
            currentVehicleType = vehicleType;
            
            // Select the vehicle based on the dropdown value
            if (vehicleType === 'airplane1') {
                vehicle = airplane1.clone();
                currentVehicleElement.textContent = 'Airplane 1';
            } else if (vehicleType === 'airplane2') {
                vehicle = airplane2.clone();
                currentVehicleElement.textContent = 'Airplane 2';
            } else if (vehicleType === 'car') {
                vehicle = car.clone();
                currentVehicleElement.textContent = 'Security Car';
                // Set necessary properties for the clone
                vehicle.rotation.order = 'YXZ';
                vehicle.up.set(0, 1, 0);
                vehicle.quaternion.setFromEuler(new THREE.Euler(0, 0, 0, 'YXZ'));
            }
            
            scene.add(vehicle);
            
            // Reset movement/visual angles
            headingAngle = 0;
            pitchAngle = 0;
            visualYaw = 0;
            visualPitch = 0;
            visualRoll = 0;
            desiredRoll = 0;
            
            // Set the initial position and heading
            vehicle.rotation.set(0, 0, 0); // Reset rotations to ensure heading starts at 0
            
            if (startPosition === 'runway') {
                vehicle.position.set(1, 0, 10); // Start at the side of the runway
                speed = 0; // No initial speed
            } else if (startPosition === 'midair') {
                vehicle.position.set(0, 10, 0); // Start in mid-air
                speed = 0.1; // Set initial speed
            } else if (startPosition === 'ground') {
                vehicle.position.set(0, 0, 0); // Start on the ground
                speed = 0; // No initial speed
            }
            
                        // Initialize camera position
            updateCameraPositions();
            switchCamera(0); // Reset to default camera
            
            // ËÆæÁΩÆÂºÄÂ±ÄÊó†Êïå
            invincible = true;
            invincibilityTimer = invincibilityDuration;
            if (invincibilityIndicator) {
                invincibilityIndicator.classList.remove('hidden');
            }
            // ÁªôÈ£ûÊú∫Ê∑ªÂä†ÈáëËâ≤ÂÖâËäíË°®Á§∫Êó†Êïå
            if (vehicle && vehicle.material) {
                vehicle.material.emissive = new THREE.Color(0x442200);
            }
            
            // Update the HUD to reflect the initial values
            updateHUD(0); // Heading starts at 0
            
            // Ê†πÊçÆÂ§ö‰∫∫Ê®°ÂºèÁä∂ÊÄÅÊéßÂà∂LivesÊòæÁ§∫
            const livesDisplay = document.getElementById('livesDisplay');
            if (livesDisplay) {
                if (multiplayerEnabled) {
                    livesDisplay.classList.remove('hidden');
                } else {
                    livesDisplay.classList.add('hidden');
                }
            }
        }

        // Start game function called from menu buttons
        function startGame(startPosition) {
            const selectedVehicle = document.getElementById('vehicleSelect').value;
            startGameWithSettings(selectedVehicle, startPosition);
        }

        // Handle window resize
        window.addEventListener('resize', function() {
            var width = window.innerWidth;
            var height = window.innerHeight;
            renderer.setSize(width, height);
            
            [camera, cockpitCamera, wingCamera, gearCamera].forEach(cam => {
                cam.aspect = width / height;
                cam.updateProjectionMatrix();
            });
        });

        // Keyboard event listeners (use keyState for continuous controls)
        document.addEventListener('keydown', function(event) {
            var k = event.key.toLowerCase();

            // Prevent default behavior for game controls
            if (['w', 'a', 's', 'd', 'r', 'arrowup', 'arrowdown', 'escape'].includes(k)) {
                event.preventDefault();
            }
            
            // Handle ESC key specifically for pause menu
            if (event.key === 'Escape') {
                // Only process ESC if we're in the game (not in main menu)
                if (menu.style.display === 'none') {
                    togglePause();
                    return; // Prevent other key processing for this event
                }
            }

            // Non-continuous immediate actions
            if (k === 'r') {
                restartGame();
            } else if (k === 'arrowup') {
                speed += 0.01; // Increase speed
            } else if (k === 'arrowdown') {
                speed = Math.max(0, speed - 0.01); // Decrease speed but not below 0
            } else if (k === '1') {
                switchCamera(0);
            } else if (k === '2') {
                switchCamera(1);
            } else if (k === '3') {
                switchCamera(2);
            } else if (k === '4') {
                switchCamera(3);
            }
            // Handle spacebar for missile
            if (event.code === 'Space' && multiplayerEnabled && !crashed && !isPaused) {
                event.preventDefault();
                var now = Date.now();
                if (now - lastMissileTime > missileCooldown) {
                    lastMissileTime = now;
                    
                    // Fire missile towards crosshair
                    var forwardDir = new THREE.Vector3(0, 0, 1).applyQuaternion(vehicle.quaternion);
                    var spawnPos = vehicle.position.clone().add(forwardDir.clone().multiplyScalar(3));
                    
                    // Find closest target to line of fire
                    var closestTarget = null;
                    var closestDist = 100;
                    
                    for (var a = 0; a < aiPlayers.length; a++) {
                        var ai = aiPlayers[a];
                        if (ai.lives <= 0) continue;
                        
                        // Project onto direction line
                        var toTarget = new THREE.Vector3().subVectors(ai.mesh.position, vehicle.position);
                        var proj = toTarget.dot(forwardDir);
                        if (proj > 0) {
                            var perp = new THREE.Vector3().subVectors(toTarget, forwardDir.clone().multiplyScalar(proj));
                            var dist = perp.length();
                            if (dist < 5 && proj < closestDist) {
                                closestDist = proj;
                                closestTarget = { type: 'ai', obj: ai.mesh, pos: ai.mesh.position, aiData: ai };
                            }
                        }
                    }
                    
                    var missile = createMissile(spawnPos, forwardDir, 'player', false);
                    missile.target = closestTarget;
                    missiles.push(missile);
                }
                return;
            }
            
            // Handle J key for flare
            if (event.key === 'j' && multiplayerEnabled && !crashed && !isPaused) {
                event.preventDefault();
                var now = Date.now();
                if (now - lastFlareTime > flareCooldown) {
                    lastFlareTime = now;
                    
                    // Fire flare in random direction
                    var flareDir = new THREE.Vector3(
                        (Math.random() - 0.5) * 2,
                        Math.random() * 0.5,
                        (Math.random() - 0.5) * 2
                    ).normalize();
                    
                    var flare = createFlare(vehicle.position.clone(), flareDir, 'player');
                    flares.push(flare);
                }
                return;
            }
            // For continuous controls (movement), set keyState
            keyState[k] = true;
        });

        // Keyup - clear key state and remove transient desiredRoll if needed
        document.addEventListener('keyup', function(event) {
            var k = event.key.toLowerCase();
            delete keyState[k];
        });

        // Close window confirmation
        function ShowConfirmClose() {
            if (event.clientX > document.body.clientWidth && event.clientY < 0 || event.altKey)
                window.event.returnValue = "Your game has not finished, are you sure you will leave?";
        }

        	// Initialize the game
        document.addEventListener('DOMContentLoaded', () => {
            // Ëé∑ÂèñÊñ∞Ê∑ªÂä†ÁöÑË≠¶ÂëäÂÖÉÁ¥†
            const proximityWarningEl = document.getElementById('proximityWarning');
            
            // Multiplayer toggle functionality
            const multiplayerToggle = document.getElementById('multiplayerToggle');
            const nicknameContainer = document.getElementById('nicknameContainer');
            const multiplayerHud = document.getElementById('multiplayerHud');
            const nicknameInput = document.getElementById('nicknameInput');
            const setNicknameBtn = document.getElementById('setNicknameBtn');
            const playerNameDisplay = document.getElementById('playerNameDisplay');
            const playerCountDisplay = document.getElementById('playerCountDisplay');
            
                            multiplayerToggle.addEventListener('change', function(e) {
                multiplayerEnabled = e.target.checked;
                const livesDisplay = document.getElementById('livesDisplay');
                const warningContainer = document.getElementById('warningContainer');
                
                if (multiplayerEnabled) {
                    nicknameContainer.classList.remove('hidden');
                    multiplayerHud.classList.remove('hidden');
                    nicknameInput.value = playerName;
                    
                    // AIÊ®°Âºè‰∏ãÊòæÁ§∫LivesÂíåScore
                    if (livesDisplay) {
                        livesDisplay.classList.remove('hidden');
                    }
                    
                    // ÈáçÁΩÆÁé©ÂÆ∂ÁîüÂëΩÂÄºÂíåÂàÜÊï∞
                    playerLives = 3;
                    playerScore = 0;
                    if (playerLivesEl) playerLivesEl.textContent = playerLives;
                    if (playerScoreEl) playerScoreEl.textContent = playerScore;
                    
                    // ÂàùÂßãÂåñAI
                    if (aiPlayers.length === 0) {
                        for (var i = 0; i < aiCount; i++) {
                            var pos = aiRespawnPositions[i % aiRespawnPositions.length];
                            var colors = [0xff3333, 0x33ff33, 0x3333ff, 0xffff33, 0xff33ff];
                            var ai = createAIPlane(colors[i % colors.length], 
                                new THREE.Vector3(pos.x, pos.y, pos.z), i);
                            aiPlayers.push(ai);
                        }
                    }
                } else {
                    nicknameContainer.classList.add('hidden');
                    multiplayerHud.classList.add('hidden');
                    
                    // ÈùûAIÊ®°Âºè‰∏ãÈöêËóèLivesÂíåScore
                    if (livesDisplay) {
                        livesDisplay.classList.add('hidden');
                    }
                    
                    // ÈöêËóèÊâÄÊúâË≠¶Âëä
                    if (threatWarningEl) {
                        threatWarningEl.classList.add('hidden');
                    }
                    if (proximityWarningEl) {
                        proximityWarningEl.classList.add('hidden');
                    }
                    if (invincibilityIndicator) {
                        invincibilityIndicator.classList.add('hidden');
                    }
                    
                    // Clear AI and projectiles
                    aiPlayers.forEach(ai => {
                        if (ai.mesh.parent) scene.remove(ai.mesh);
                    });
                    aiPlayers = [];
                    missiles.forEach(m => scene.remove(m.mesh));
                    missiles = [];
                    flares.forEach(f => scene.remove(f.mesh));
                    flares = [];
                    
                    // ÈáçÁΩÆÊó†ÊïåÁä∂ÊÄÅ
                    invincible = false;
                    invincibilityTimer = 0;
                }
                
                playerCountDisplay.textContent = multiplayerEnabled ? '5 AI' : '0 AI';
            });
            
            setNicknameBtn.addEventListener('click', function() {
                var name = nicknameInput.value.trim();
                if (name) {
                    playerName = name;
                    playerNameDisplay.textContent = playerName;
                    
                    // Initialize AI
                    if (multiplayerEnabled && aiPlayers.length === 0) {
                        for (var i = 0; i < aiCount; i++) {
                            var pos = aiRespawnPositions[i % aiRespawnPositions.length];
                            var colors = [0xff3333, 0x33ff33, 0x3333ff, 0xffff33, 0xff33ff];
                            var ai = createAIPlane(colors[i % colors.length], 
                                new THREE.Vector3(pos.x, pos.y, pos.z), i);
                            aiPlayers.push(ai);
                        }
                    }
                }
            });
            
            nicknameInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') setNicknameBtn.click();
            });
            // Start the animation loop
            animate();
            
            // Add GSAP for animations
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.4/gsap.min.js';
            document.head.appendChild(script);
        });
        
        // Add before unload event
        window.addEventListener('beforeunload', ShowConfirmClose);
    </script>
</body>
</html>
